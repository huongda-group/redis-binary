name: Watch Redis Release and Build

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Bấm chọn để ép build lại version hiện tại'
        type: boolean
        default: true

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.check.outputs.new_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Get latest Redis release
        id: check
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/redis/redis/releases/latest | jq -r .tag_name)
          MY_LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          
          # Nếu chạy thủ công hoặc có version mới
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "$LATEST_TAG" != "$MY_LATEST_RELEASE" ]; then
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          else
            echo "new_release=false" >> $GITHUB_OUTPUT
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.new_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: "Ubuntu_25.10"
            container: "ubuntu:25.10"
          - os_name: "Ubuntu_25.04"
            container: "ubuntu:25.04"
          - os_name: "Ubuntu_24.04"
            container: "ubuntu:24.04"
          - os_name: "Ubuntu_22.04"
            container: "ubuntu:22.04"
          - os_name: "AlmaLinux_10"
            container: "almalinux:10"
          - os_name: "AlmaLinux_9"
            container: "almalinux:9"
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container }}
    
    steps:
      - name: Install dependencies
        run: |
          if command -v apt-get &> /dev/null; then
            apt-get update && apt-get install -y build-essential wget tar
          else
            dnf groupinstall -y "Development Tools" && dnf install -y wget tar
          fi

      - name: Download and Build Redis
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          wget https://github.com/redis/redis/archive/refs/tags/${VERSION}.tar.gz -O redis.tar.gz
          tar -xzf redis.tar.gz
          cd redis-${VERSION}
          make MALLOC=jemalloc -j$(nproc)
          
          mkdir -p ../dist
          BINARY_NAME="redis-server-${{ matrix.os_name }}"
          cp src/redis-server ../dist/${BINARY_NAME}
          
          # Tạo file checksum SHA256
          cd ../dist
          sha256sum ${BINARY_NAME} > ${BINARY_NAME}.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: redis-${{ matrix.os_name }}
          path: dist/

  publish-release:
    needs: [check-version, build-and-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Quyền quan trọng để tạo/xóa release
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-bins
          merge-multiple: true

      - name: Delete existing Release (if re-build)
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          name: Redis Release ${{ needs.check-version.outputs.version }}
          body: |
            ## Automated Redis Build for Panel
            - **Version:** ${{ needs.check-version.outputs.version }}
            - **Build Date:** ${{ github.event.head_commit.timestamp || 'Manual Trigger' }}
            - **Source:** [Redis Upstream](https://github.com/redis/redis/releases/tag/${{ needs.check-version.outputs.version }})
          files: all-bins/*
          token: ${{ secrets.GITHUB_TOKEN }}
